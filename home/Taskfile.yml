# yaml-language-server: $schema=https://taskfile.dev/schema.json
# ~/.Taskfile.yml
#
# docs: https://taskfile.dev
#
# --- Windows ---
# winget install Task.Task
#
# --- Linux ---
# sh -c "$(curl -fsSL https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin
# echo 'command -v task >/dev/null || export PATH="$PATH:$HOME/.local/bin"' >> ~/.profile
# source ~/.profile
#
# --- macOS ---
# brew install go-task/tap/go-task
---
version: "3"

set: [pipefail]
shopt: [globstar]

dotenv: [.env, ".{{.ENV}}/.env", "{{.ENV}}/.env"]

# vars:
#   REPO_ABS_ROOT_PATH:
#     sh: git rev-parse --show-toplevel
#   CURRENT_BRANCH:
#     sh: git rev-parse --abbrev-ref HEAD

includes:
  internal: .taskfiles/_internal.Taskfile.yml
  runtime: .taskfiles/runtime.Taskfile.yml
  api: .taskfiles/api.Taskfile.yml
  sh: .taskfiles/shell.Taskfile.yml
  gh: .taskfiles/github.Taskfile.yml
  go: .taskfiles/golang.Taskfile.yml
  js: .taskfiles/javascript.Taskfile.yml
  md: .taskfiles/markdown.Taskfile.yml
  # sec: .taskfiles/security.Taskfile.yml
  spell: .taskfiles/spell.Taskfile.yml
  tf: .taskfiles/terraform.Taskfile.yml
  yml: .taskfiles/yaml.Taskfile.yml
  # site: .taskfiles/site.Taskfile.yml
  # project: .taskfiles/project.Taskfile.yml
  k8s: .taskfiles/kubernetes.Taskfile.yml
  utils: .taskfiles/utils.Taskfile.yml

tasks:
  default:
    desc: List available tasks
    silent: true
    cmds:
      - task --list

  sysinfo:
    desc: Display system information
    silent: true
    cmds:
      # yamllint disable-line rule:quoted-strings
      - 'echo "OS: {{OS}}"' # windows, linux, darwin
      # yamllint disable-line rule:quoted-strings
      - 'echo "Architecture: {{ARCH}}"' # amd64, arm64, etc.
      # yamllint disable-line rule:quoted-strings
      - 'echo "CPU cores: {{numCPU}}"' # Number of CPU cores

  init:
    desc: List available tasks
    silent: true
    cmds:
      - task: runtime:setup
      # - fnm install {{.NODE_VERSION}}
      # - fnm use {{.NODE_VERSION}}
      # - node --version
      # - uv python install --default "$(cat .python-version)" --preview-features python-install-default
      # - python --version
      # - task: tools
    dir: "{{.USER_WORKING_DIR}}"

  tools:
    desc: Install tools
    vars:
      ITEMS:
        - api
        - sh
        - gh
        - go
        - js
        - md
        # - sec
        - spell
        - tf
        - yml
        # - site
        - k8s
        - utils
    cmds:
      - for: { var: ITEMS }
        task: "{{.ITEM}}:tools"

  lint:
    desc: Lint files
    vars:
      ITEMS:
        - api
        - sh
        - gh
        - js
        - md
        # - sec
        - spell
        - tf
        - yml
    deps:
      - for: { var: ITEMS }
        task: "{{.ITEM}}:lint"

  diff:
    desc: Check for differences
    silent: true
    status:
      - git diff --shortstat --exit-code
    cmds:
      - cmd: |
          echo "âš ï¸âš ï¸âš ï¸ Unexpected difference. Run 'task -g {{.CLI_ARGS}}' command and commit. âš ï¸âš ï¸âš ï¸"
          echo
          echo "ğŸ›‘ğŸ›‘ğŸ›‘ Uncommitted changes ğŸ›‘ğŸ›‘ğŸ›‘"
          echo
          git status --short
          echo
          echo "ğŸ“ğŸ“ğŸ“ Summary ğŸ“ğŸ“ğŸ“"
          echo
          git diff --compact-summary
          echo
          echo "ğŸ”ğŸ”ğŸ” Differences ğŸ”ğŸ”ğŸ”"
          echo
          git --no-pager diff
          echo
          exit 1

  git:clean:
    dir: "{{.USER_WORKING_DIR}}"
    cmds:
      - cmd: |
          {{.PWSH}} "git fetch -p; git branch -vv | ?{ $_ -match ': gone]' } | %{ $_.Trim().Split(' ')[0] } | %{ git branch -D $_ }"
        platforms: [windows]
      - cmd: |
          git fetch -p; git branch -vv | grep ': gone]' | awk '{print $1}' | xargs git branch -D
          # git fetch -p && for branch in `git branch -vv | grep ': gone]' | awk '{print $1}'`; do git branch -D $branch; done
        platforms: [linux, darwin]
