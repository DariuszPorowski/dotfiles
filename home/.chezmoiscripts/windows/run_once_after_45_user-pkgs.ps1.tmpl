{{- if .pkgs.windows.winget -}}

$env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

if (-not (Get-Command "winget" -ErrorAction SilentlyContinue)) {
    Write-Error "WinGet hasn't been installed!"
    exit
}

Write-Host 'INSTALLING WINGET PACKAGES (USER)...'

$userPackages = @(
{{- range .pkgs.windows.winget.user }}
    {{- if kindIs "string" . }}
    @{ Id = '{{ . }}'; Override = $null }
    {{- else }}
    @{ Id = '{{ .id }}'; Override = '{{ .override | replace "'" "''" }}' }
    {{- end }}
{{- end }}
)

foreach ($pkg in $userPackages) {
    Write-Host "Installing user-scope package: $($pkg.Id)"

    $wingetArgs = @(
        'install',
        '--id', $pkg.Id,
        '--exact',
        '--accept-source-agreements',
        '--accept-package-agreements',
        '--disable-interactivity',
        # '--ignore-security-hash',
        '--scope', 'user'
    )

    if ($pkg.Override) {
        $wingetArgs += '--override'
        $wingetArgs += "`"$($pkg.Override)`""
    }

    & winget $wingetArgs
}

{{- end }}

Write-Host 'CONFIGURING PACKAGES (USER)...'

if (Get-Command "oh-my-posh" -ErrorAction SilentlyContinue) {
    Write-Host 'Installing Meslo font...'
    oh-my-posh font install meslo
}

if (Get-Command "code" -ErrorAction SilentlyContinue) {
    Write-Host 'Installing VSCode extensions...'
    code --install-extension ms-vscode-remote.remote-wsl
}

Write-Host 'UPGRADING WINGET PACKAGES (USER)...'
winget upgrade --all --accept-package-agreements --accept-source-agreements --disable-interactivity --scope=user
