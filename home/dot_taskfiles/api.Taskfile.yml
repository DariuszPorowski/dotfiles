# yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
---
version: "3"

vars:
  API_VERSION:
    map:
      autorest: latest
      oav: latest
      typespec: latest

tasks:
  # * Install Autorest
  install:autorest:
    desc: Install Autorest
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: autorest@{{.API_VERSION.autorest}}

  # * Install OAV
  install:oav:
    desc: Install OAV
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: oav@{{.API_VERSION.oav}}

  # * Install TypeSpec
  install:typespec:
    desc: Install TypeSpec
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: "@typespec/compiler@{{.API_VERSION.typespec}}"

  # * Tools
  tools:
    desc: Install API tools
    vars:
      ITEMS:
        - autorest
        - oav
        - typespec
    cmds:
      - for: { var: ITEMS }
        task: install:{{.ITEM}}

  # * Run TypeSpec Format
  run:tsp:format:
    desc: Run TypeSpec Format
    preconditions:
      - sh: task -g internal:command -- tsp
        msg: "❌ Error: tsp is not installed. Please run 'task -g api:install:typespec'"
      - sh: task -g internal:command:version -- "tsp --version" "{{.API_VERSION.typespec}}"
        msg: "❌ Version Mismatch: You are not using {{.API_VERSION.typespec}} version. Please run 'task -g api:install:typespec'"
    sources:
      - "**/*.tsp"
    cmds:
      - tsp format "**/*.tsp"
    dir: "{{.USER_WORKING_DIR}}"

  # * Lint
  lint:
    desc: Lint API files
    cmds:
      - task: run:tsp:format
