# yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
---
version: "3"

tasks:
  # * Install CSpell
  install:cspell:
    desc: Install CSpell
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: cspell@{{.VERSION.cspell}}

  # * Install CodeSpell
  install:codespell:
    desc: Install CodeSpell
    cmds:
      - task: :internal:_install:uv
        vars:
          APP: codespell@{{.VERSION.codespell}}

  # * Install Lychee
  install:lychee:
    desc: Install Lychee
    cmds:
      - task: :internal:_install:winget
        vars:
          APP: lycheeverse.lychee
          VERSION: "{{.VERSION.lychee}}"
      - task: :internal:_install:brew
        vars:
          APP: lychee@{{.VERSION.lychee}}
      - cmd: |
          ./scripts/install_lychee.sh "{{.VERSION.lychee}}"
        platforms: [linux]
    dir: "{{.TASKFILE_DIR}}"

  # * Tools
  tools:
    desc: Install Spell tools
    vars:
      ITEMS:
        - cspell
        - codespell
        - lychee
    cmds:
      - for: { var: ITEMS }
        task: install:{{.ITEM}}

  # * Run CodeSpell
  run:codespell:
    desc: Run CodeSpell
    preconditions:
      - sh: task -g internal:command -- codespell
        msg: "❌ Error: codespell is not installed. Please run 'task spell:install:codespell'"
      - sh: task -g internal:command:version -- "codespell --version" "{{.VERSION.codespell}}"
        msg: "❌ Version Mismatch: You are not using {{.VERSION.codespell}} version. Please run 'task spell:install:codespell'"
    cmds:
      - codespell --config ~/.linters/.codespellrc --summary --write-changes
    dir: "{{.USER_WORKING_DIR}}"

  # * Run CSpell
  run:cspell:
    desc: Run CSpell
    preconditions:
      - sh: task -g internal:command -- cspell
        msg: "❌ Error: cspell is not installed. Please run 'task spell:install:cspell'"
      - sh: task -g internal:command:version -- "cspell --version" "{{.VERSION.cspell}}"
        msg: "❌ Version Mismatch: You are not using {{.VERSION.cspell}} version. Please run 'task spell:install:cspell'"
    cmds:
      - cspell --config ~/.linters/.cspell.yml "./**/*.md"
    dir: "{{.USER_WORKING_DIR}}"

  # * Run Lychee
  run:lychee:
    desc: Run Lychee
    preconditions:
      - sh: task -g internal:command -- lychee
        msg: "❌ Error: lychee is not installed. Please run 'task spell:install:lychee'"
      - sh: task -g internal:command:version -- "lychee --version" "{{.VERSION.lychee}}"
        msg: "❌ Version Mismatch: You are not using {{.VERSION.lychee}} version. Please run 'task spell:install:lychee'"
    cmds:
      - lychee --config ~/.linters/.lychee.toml --format markdown .
    dir: "{{.USER_WORKING_DIR}}"

  # * Lint
  lint:
    desc: Lint Spell files
    cmds:
      - task: run:codespell
      - task: run:cspell
      - task: run:lychee
