{{- if .pkgs.windows.psGallery -}}

$env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

# Self-elevate the script if required
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
  $currentProcess = Get-Process -Id $PID
  $argumentList = "-File `"$($MyInvocation.MyCommand.Path)`" $($MyInvocation.UnboundArguments)"
  Start-Process -FilePath $currentProcess.Path -Verb RunAs -ArgumentList $argumentList -Wait
  Exit
}

Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

Import-Module PowerShellGet

Write-Host 'INSTALLING PSGALLERY MODULES...'

{{ range $module := .pkgs.windows.psGallery }}
Write-Host "Installing PSGallery module: {{ $module }}"
Install-Module -Name '{{ $module }}' -Repository PSGallery -SkipPublisherCheck -AcceptLicense #-Force
{{- end }}

{{- end }}
